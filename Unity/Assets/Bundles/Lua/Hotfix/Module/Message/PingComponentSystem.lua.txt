-- Generated by CSharp.lua Compiler
local System = System
local ET = ET
System.namespace("ET", function (namespace)
  namespace.class("PingComponentAwakeSystem", function (namespace)
    local Awake, PingAsync
    Awake = function (this, self)
      PingAsync(self):Coroutine()
    end
    PingAsync = function (self)
      return System.async(function (async, self)
        local session = self:GetParent(ET.Session)
        local instanceId = self.InstanceId

        while true do
          if self.InstanceId ~= instanceId then
            return
          end

          local time1 = ET.TimeHelper.ClientNow()
          local default, extern = System.try(function ()
            local response = System.as(async:Await(session:Call1(self.C2G_Ping)), ET.G2C_Ping)

            if self.InstanceId ~= instanceId then
              return true
            end

            local time2 = ET.TimeHelper.ClientNow()
            self.Ping = time2 - time1

            ET.Game.getTimeInfo().ServerMinusClientTime = response.Time + System.div((time2 - time1), 2) - time2

            async:Await(ET.TimerComponent.Instance:WaitAsync(2000))
          end, function (default)
            if System.is(default, ET.RpcException) then
              local e = default
              -- session断开导致ping rpc报错，记录一下即可，不需要打成error
              ET.Log.Info("ping error: " .. self.Id .. " " .. e.Error)
              return true
            else
              local e = default
              ET.Log.Error("ping error: \n" .. System.toString(e))
            end
          end)
          if default then
            return extern
          end
        end
      end, nil, self)
    end
    return {
      base = function (out)
        return {
          out.ET.AwakeSystem_1(out.ET.PingComponent)
        }
      end,
      Awake = Awake,
      __metadata__ = function (out)
        return {
          class = { 0x6, out.ET.ObjectSystemAttribute() }
        }
      end
    }
  end)

  namespace.class("PingComponentDestroySystem", function (namespace)
    local Destroy
    Destroy = function (this, self)
      self.Ping = 0
    end
    return {
      base = function (out)
        return {
          out.ET.DestroySystem_1(out.ET.PingComponent)
        }
      end,
      Destroy = Destroy,
      __metadata__ = function (out)
        return {
          class = { 0x6, out.ET.ObjectSystemAttribute() }
        }
      end
    }
  end)
end)
